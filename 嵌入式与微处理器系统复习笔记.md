# åµŒå…¥å¼ä¸å¾®å¤„ç†å™¨ç³»ç»Ÿå¤ä¹ ç¬”è®°


# å¾®å¤„ç†å™¨åŸºæœ¬æ¦‚å¿µï¼ˆâ‰¤10%ï¼‰

---

## å¾®å¤„ç†å™¨åŸºæœ¬ç»“æ„ ALU CPU MMU

- å¤„ç†å™¨å­—é•¿ï¼šå¤„ç†å™¨ALUå’Œé€šç”¨æ•°æ®å¯„å­˜å™¨ä½å®½
- ALUã€CPU ç•¥
- MMUï¼š
    - æ§åˆ¶è™šæ‹Ÿåœ°å€ï¼ˆVAï¼‰æ˜ å°„åˆ°ç‰©ç†åœ°å€ï¼ˆPAï¼‰
    - æ§åˆ¶å†…å­˜çš„è®¿é—®æƒé™
    - æ§åˆ¶å¯ç¼“å­˜æ€§å’Œç¼“å†²æ€§

## é€šå¸¸çš„è¯„ä¼°å¤„ç†å™¨æ€§èƒ½çš„åŸºæœ¬å‚æ•°ï¼ŒæŒ‡æ ‡ï¼Œå¦‚MIPSï¼ŒCPI

- CPI = ä¸€ä¸ªç¨‹åºè¿è¡Œçš„CPUæ—¶é’Ÿå‘¨æœŸ/è¯¥ç¨‹åºçš„æŒ‡ä»¤æ•°
- MIPS = æ¯ç§’ç™¾ä¸‡æ¡æŒ‡ä»¤ = æŒ‡ä»¤æ•°/ï¼ˆæŒ‡ä»¤çš„è¿è¡Œæ—¶é—´Ã—10^6ï¼‰ = æ—¶é’Ÿé¢‘ç‡/ï¼ˆCPIÃ—10^6ï¼‰
- MFLOPS = æ¯ç§’ç™¾ä¸‡æ¬¡æµ®ç‚¹è¿ç®—æ¬¡æ•°/ï¼ˆæµ®ç‚¹è¿ç®—çš„æ—¶é—´Ã—10^6ï¼‰

## å¤„ç†å™¨æŒ‡ä»¤æ‰§è¡Œè¿‡ç¨‹ï¼Œå–æŒ‡ï¼Œè¯‘ç ï¼Œæ‰§è¡Œï¼Œå†™å›

## æµæ°´çº¿ï¼Œå½±å“æµæ°´çº¿çš„å› ç´ 

- ç»“æ„å†²çªï¼Œå¤šæ¡æŒ‡ä»¤åŒæ—¶äº‰ç”¨åŒä¸€èµ„æºå¯¼è‡´çš„å†²çª
- æ•°æ®å†²çª
- æ§åˆ¶å†²çª

## cacheçš„å‘½ä¸­ç‡ï¼Œå½±å“cacheå‘½ä¸­ç‡çš„å› ç´ 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled.png)

> æ¦‚å¿µ
> 

Cacheå‘½ä¸­ç‡æ˜¯è¡¡é‡Cacheæ€§èƒ½çš„ä¸€ä¸ªæŒ‡æ ‡ã€‚ å®ƒè¡¨ç¤ºçš„æ˜¯ç³»ç»Ÿåœ¨è®¿é—®æ•°æ®æ—¶ï¼ŒæˆåŠŸä»Cacheä¸­è·å–æ•°æ®çš„æ¯”ä¾‹ã€‚ï¼ˆCacheå‘½ä¸­æ¬¡æ•°Ã·å­˜å‚¨å™¨è¯·æ±‚æ¬¡æ•°ï¼‰Ã—100ï¼…

> å› ç´ 
> 
- å®¹é‡ï¼šCacheçš„å‘½ä¸­ç‡éšå®ƒçš„å®¹é‡çš„å¢åŠ è€Œæé«˜ï¼Œå®ƒä»¬ä¹‹é—´çš„å…³ç³»æ›²çº¿å¦‚å›¾æ‰€ç¤ºã€‚åœ¨Cacheå®¹é‡æ¯”è¾ƒå°çš„æ—¶å€™ï¼Œå‘½ä¸­ç‡æé«˜å¾—éå¸¸å¿«ï¼Œä½†æ ¹æ®è¾¹é™…æ•ˆåº”é€’å‡åŸç†éšç€Cacheå®¹é‡çš„å¢åŠ ï¼Œå‘½ä¸­ç‡æé«˜çš„é€Ÿåº¦é€æ¸é™ä½ã€‚
    
    ![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%201.png)
    
- å—å¤§å°ï¼šå¯¹äºç»™å®šçš„Cacheå®¹é‡ï¼Œå½“å—å¤§å°å¢åŠ æ—¶ï¼Œå‘½ä¸­ç‡å¼€å§‹æ—¶å¤„äºä¸Šå‡è¶‹åŠ¿ï¼Œåæ¥åè€Œä¼šä¸‹é™ã€‚
    
    ![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%202.png)
    
- ä¸ä¸»å­˜çš„æ˜ å°„æ–¹å¼ï¼š
1. å…¨ç›¸è”æ–¹å¼
åº”ç”¨å…¨ç›¸è”æ–¹å¼å‘½ä¸­ç‡æ¯”è¾ƒé«˜ï¼ŒCacheå­˜å‚¨ç©ºé—´åˆ©ç”¨ç‡é«˜ã€‚ä½†æ˜¯è®¿é—®ç›¸å…³å­˜å‚¨å™¨æ—¶ï¼Œæ¯æ¬¡éƒ½è¦ä¸å…¨éƒ¨å†…å®¹æ¯”è¾ƒï¼Œé€Ÿåº¦ä½ï¼Œæˆæœ¬é«˜ï¼Œå› è€Œåº”ç”¨å°‘ã€‚
2.  ç›´æ¥ç›¸è”æ–¹å¼
åº”ç”¨ç›´æ¥ç›¸è”æ–¹å¼åœ°å€æ˜ åƒæ–¹å¼ç®€å•ï¼Œæ•°æ®è®¿é—®æ—¶ï¼Œåªéœ€æ£€æŸ¥åŒºå·æ˜¯å¦ç›¸ç­‰å³å¯ï¼Œå› è€Œå¯ä»¥å¾—åˆ°æ¯”è¾ƒå¿«çš„è®¿é—®é€Ÿåº¦ï¼Œç¡¬ä»¶è®¾å¤‡ç®€å•ã€‚ä½†æ˜¯ä½¿å¾—æ›¿æ¢æ“ä½œé¢‘ç¹ï¼Œå‘½ä¸­ç‡æ¯”è¾ƒä½ã€‚
3. ç»„ç›¸è”æ˜ åƒæ–¹å¼
åº”ç”¨ç»„ç›¸è”æ–¹å¼å—çš„å†²çªæ¦‚ç‡æ¯”è¾ƒä½ï¼Œå—çš„åˆ©ç”¨ç‡å¤§å¹…åº¦æé«˜ï¼Œå—å¤±æ•ˆç‡æ˜æ˜¾é™ä½ã€‚ä½†æ˜¯å®ç°éš¾åº¦å’Œé€ ä»·è¦æ¯”ç›´æ¥æ˜ åƒæ–¹å¼é«˜ã€‚
- æ›¿æ¢ç­–ç•¥

è¿‘æœŸæœ€å°‘ä½¿ç”¨ï¼ˆLRUï¼‰> å…ˆè¿›å…ˆå‡ºï¼ˆFIFO) > éšæœºï¼ˆRANDï¼‰

## ç¨‹åºå¼€å‘è¿‡ç¨‹ï¼Œç¼–è¯‘ï¼Œæ±‡ç¼–ï¼Œé“¾æ¥çš„è¾“å…¥è¾“å‡º

åµŒå…¥å¼å¼€å‘æµç¨‹æ¯”PCå¼€å‘æµç¨‹å¤šä¸€ä¸ªä¸‹è½½ï¼Œç¼–è¾‘ã€ç¼–è¯‘ã€æ±‡ç¼–ã€é“¾æ¥ã€ï¼ˆä¸‹è½½ï¼‰ã€è°ƒè¯•

## å¼‚å¸¸ä¸ä¸­æ–­

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%203.png)

# ARM(60%)

---

## ARMå¤„ç†å™¨

### ARM9å†…æ ¸

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%204.png)

ğŸ’¡R13 spï¼Œ R14 lr,  R15 pc

**â—ç§»ä½ç‰¹æ€§ï¼Œè®¿å­˜ç‰¹æ€§ï¼ˆload storeæ¶æ„ï¼Œè®¿å­˜ä¸“ç”¨æŒ‡ä»¤ï¼‰RISCæ¶æ„**

RISCï¼Œå³ç²¾ç®€æŒ‡ä»¤é›†è®¡ç®—æœºï¼Œæ˜¯ä¸€ç§å¤„ç†å™¨æ¶æ„ï¼Œå…¶ç‰¹ç‚¹æ˜¯æŒ‡ä»¤é›†ç²¾ç®€ã€ç®€å•æ˜äº†ã€‚RISCæ¶æ„çš„å¤„ç†å™¨é€šå¸¸åªæ”¯æŒæœ‰é™çš„æŒ‡ä»¤é›†ï¼Œä¸”è¿™äº›æŒ‡ä»¤çš„æ‰§è¡Œé€Ÿåº¦éå¸¸å¿«ã€‚è¿™ç§è®¾è®¡ä½¿å¾—RISCæ¶æ„çš„å¤„ç†å™¨åœ¨åŠŸè€—ã€æ€§èƒ½ç­‰æ–¹é¢å…·æœ‰ä¼˜åŠ¿ã€‚å¸¸è§çš„RISCæ¶æ„å¤„ç†å™¨åŒ…æ‹¬ARMå’ŒMIPSç­‰ã€‚

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%205.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%206.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%207.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%208.png)

### å¼‚å¸¸æ¨¡å¼

- å¼‚å¸¸å‘é‡ã€å¼‚å¸¸æ¨¡å¼

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%209.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2010.png)

ä½äºCPSRæœ€ä½å­—èŠ‚ï¼ŒCä½ï¼ˆæ§åˆ¶åŸŸï¼‰ï¼ŒCPSRçš„é«˜8ä½ä¸ºæ ‡å¿—åŸŸï¼Œå­˜æ”¾nzcvqift

### LoadStore æ¶æ„

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2011.png)

## ARMæŒ‡ä»¤

### æ ¼å¼

- æŒ‡ä»¤æ ¼å¼

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2012.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2013.png)

### å˜é‡ä¸å¸¸é‡

**å¯„å­˜å™¨å¸¸é‡è£…è½½æ–¹å¼**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2014.png)

```nasm
**ImagewidthÂ Â Â  equÂ Â Â  160
ImageheightÂ Â  equÂ Â Â  120**
```

```nasm
;åˆå§‹åŒ– r5=0ï¼Œr6=0
  mov r5, #0
  mov r6, #0
;åˆå§‹åŒ– r5=0ï¼Œr6=0
  ldr r5 , =0
  ldr r6,  =0

```

**MOVæŒ‡ä»¤**

å¿…é¡»æ˜¯8-bitï¼Œ0x0 - 0xff ï¼ˆ0-255ï¼‰ï¼Œå¹¶å¯ä»¥é€šè¿‡ä»»æ„å¶æ•°ç§»ä½

â“æŒ‡å‡ºä¸‹åˆ—é”™è¯¯çš„æŒ‡ä»¤

```nasm
MOV r0, #0x55 ;R0 = 0x55
MVN r0, #0x55 ;R0 = 0xffffffaa

MOV rn ,#1025 é”™
MOV rn ,#4096 å¯¹
MVN rn ,#0x111 é”™
MVN rn ,#0xffffffff å¯¹
```

```nasm
ï¼›PRE
  ï¼›R0=0x80
  ï¼›R1=0x50
MOV R0, R1, LSL #4
ï¼›POST 
  ; R0 = 0x500
  ; R1 = 0x50
```

**LDRæŒ‡ä»¤**

å¦‚æœæ˜¯åœ¨ä¸Šè¿°èŒƒå›´å†…ï¼Œå°±ç­‰åŒäºæ‰§è¡ŒMOV (MVN)

å¦åˆ™

- Places the value in a literal pool
- LDR -> program-relative address, reads the constant from the literal pool.
- åœ°å€è¦å­˜æ”¾åœ¨Â±4KBèŒƒå›´å†…ï¼Œå¦‚æœæ˜¯thumbæŒ‡ä»¤ï¼Œåˆ™æ˜¯Â±1KB

ç­‰åŒäºLDRÂ Â Â Â Â  rn, [pc, #offset to literal pool]

â“ä¸ºä»€ä¹ˆ â€œLTORGâ€ è¦æ”¾åœ¨è·³è½¬åæˆ–è¿”å›åï¼Ÿ

ä¸ä¼šå½“ä½œæŒ‡ä»¤å–è¿›å» 

**ADRæŒ‡ä»¤**
ä¼ªæŒ‡ä»¤ï¼Œéœ€è¦èƒ½å¤Ÿè½¬æ¢æˆä¸€æ¡æŒ‡ä»¤ï¼ˆADDï¼ŒSUBï¼‰ å¯ä»¥è·å–Â±1MBçš„åœ°å€

```nasm
start
    â€¦â€¦
    â€¦â€¦
    ADR r0, start
    ADR r1, next
    â€¦â€¦
    â€¦â€¦
next
    â€¦â€¦	 

```

```nasm
start
    â€¦â€¦
    â€¦â€¦
    SUB r0, pc, #offset1
    ADD r1, pc, #offset2
    â€¦â€¦
    â€¦â€¦
next
   â€¦â€¦	
```

**ADRLæŒ‡ä»¤**

ä¼ªæŒ‡ä»¤ï¼Œéœ€è¦èƒ½å¤Ÿè½¬æ¢æˆä¸¤æ¡æŒ‡ä»¤ï¼ˆADDï¼ŒSUBï¼‰

```nasm
start
    â€¦â€¦
    â€¦â€¦
   ADRL r0, start
   ADRL r1, next\
          +0x2000
    â€¦â€¦
    â€¦â€¦
next
    â€¦â€¦	 

```

```nasm
start
    â€¦â€¦
    â€¦â€¦
    SUB r0, pc, #offset1
    SUB r0, r0, #offset1_1
    ADD r1, pc, #offset2
    ADD r1, r1, #offset2_2
    â€¦â€¦
    â€¦â€¦
next
   â€¦â€¦	 

```

## è¿ç®—æŒ‡ä»¤ï¼ŒADD(S)ï¼ŒSUB(S)ï¼Œæ³¨æ„label

### Overview

> è¯­æ³•
> 

**Op{cond}{s} Rd, Rn, shift_operand**

> æ ‡å¿—ä½
> 

**N, Z, C,V**

### åŠ æ³•/å‡æ³•

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2015.png)

> ç§»ä½
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2016.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2017.png)

ASRï¼šç®—æœ¯å³ç§»ï¼Œ LSRï¼šé€»è¾‘å³ç§»ï¼ŒRORï¼šå¾ªç¯å³ç§»ï¼ŒLSLï¼šé€»è¾‘å·¦ç§»ï¼ŒRRXï¼šå¸¦æ‰©å±•çš„å¾ªç¯å³ç§»

- <shifter_imm>ï¼šLï¼š0-31ï¼ŒRï¼š1-32
- RRXåªèƒ½ç§»åŠ¨ä¸€ä½

â“æŒ‡å‡ºä¸‹åˆ—é”™è¯¯çš„æŒ‡ä»¤

```nasm
ADC	r1, r1, #5 ;å¯¹
SUB 	r11, r12, r3, ASR #5 ;å¯¹ 
RSB 	r5, r3, r4, LSR #32 ;å¯¹
ADD 	r3, r7, #1023 ;é”™, in range 0-255               
SUB 	r11, r12, r3, LSL #32 ;é”™
SBC 	r5, r4, r4, RRX #3 ;é”™
```

â“ä¸‹åˆ—ä¸¤æ¡æŒ‡ä»¤çš„è¿è¡Œç»“æœ

```nasm
;PRE
  ;R0=0x00
  ;R1=0x02
  ;R2=0x01
  ;cpsr=nzcvqiFt_USER
	
  SUBS  R0, R1, R2

;POST
  ;R0=?
  ;R1=?
  ;cpsr=?

```

```nasm
;PRE
     ;R0=0x00
     ; R1=0x000000C
     ; R2=0x01

      RSB  R0, R1, R2 LSL #2

;POST
       ;R0=0xfffffff8
       ;R1=0x0000000C

```

### ä¹˜æ³•

> MUL/MLA
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2018.png)

â—**dâ‰ m 32bits*32bits = low 32bits**

> UMULL/UMLAL
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2019.png)

â“ä¸‹åˆ—æŒ‡ä»¤çš„è¿è¡Œç»“æœ

```nasm
PRE
R0=0x00	
R1=0x02
R2=0x02

MUL  R0, R1, R2

POST
R0=4
R1=R1
R2=R2
```

```nasm
PRE
R0=0x00
R1=0x00
R2=0xf0000002
R3=0x02

UMULL  R0, R1, R2, R3

POST
R0=0xe0000004
R1=0x1
	
```

### é€»è¾‘

**Op{cond}{s}Â  Rd, Rn, shift_operand**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2020.png)

### æ¯”è¾ƒ

**Op{cond}Â  Rn, shift_operand**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2021.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2022.png)

## è·³è½¬æŒ‡ä»¤çš„å„ç§å˜ç§ï¼ˆB, BL, BX, BLXï¼‰

### Overview

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2023.png)

**â“B è·³è½¬æœ€å¤§åœ°å€è·ç¦»ï¼šÂ±32MB**

lrå­˜æ”¾äº†è·³è½¬å‰ä¸‹ä¸€æ¡æŒ‡ä»¤çš„åœ°å€

æ¡ä»¶è·³è½¬ & éæ¡ä»¶è·³è½¬ï¼ˆæœ‰æ—¶é—´å†çœ‹çœ‹ï¼‰ 

BMIï¼šN set

Eå’ŒTç»“å°¾çš„åŸºæœ¬éƒ½æ˜¯signedï¼ŒLSå’ŒHIåˆ™æ˜¯unsigned

### æ¡ä»¶æ‰§è¡Œ

```nasm
ADD     r0, r1, r2    
ADDS    r0, r1, r2    
ADDCSS  r0, r1, r2    ; If C flag set then r0 = r1 + r2, 	and update flags
```

â“ä»¥ä¸‹ç¨‹åºä¸­é‚£äº›æŒ‡ä»¤ä¸æ‰§è¡Œ

```nasm
  MOV r0, #1
	MOV r1, #2
	CMP r0, r1
	SUBGT r0,r0,r1 ;ä¸æ‰§è¡Œ
	SUBLT r1,r1,r0 ;æ‰§è¡Œï¼Œr1=1
		CMP r0,r1
	SUBGT r0,r0,r1 ;ä¸æ‰§è¡Œ
	SUBLT r1,r1,r0 ;ä¸æ‰§è¡Œ

```

## load/store å„ç§å˜ç§

### å†…å­˜åˆ†é…

**å®šä¹‰**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2024.png)

**ä¸¾ä¾‹**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2025.png)

åŠ Uä¸éœ€è¦å¯¹é½

```c
//Declare 
typedef struct Point
{
    	float x;
  	float y;
	float z;
} Point;

//Allocate space
Point origin;

```

```nasm
//Declare 
PointBase   RN      r11
                    MAP     0, PointBase
Point_x       FIELD   4
Point_y       FIELD   4
Point_z       FIELD   4

//Allocate space
origin  	SPACE   12
; MAPå®šä¹‰èµ·å§‹åœ°å€
; FIELDå®šä¹‰é•¿åº¦
; SPACEåˆ†é…å†…å­˜ç©ºé—´
```

### è¯»å†…å­˜æŒ‡ä»¤

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2026.png)

è¿›è¡Œæœ‰ç¬¦å·çš„LDçš„æ—¶å€™ï¼Œä¸æ”¯æŒç§»ä½ç‰¹æ€§ï¼Œä¸”offsetç”±12ä½ç¼©å‡ä¸º8ä½

**Address1**

- [Rn]
- **å‰åç§»ï¼ŒRnä¸å˜**
    - [Rn, # +/- offset_12]
    - [Rn, +/-Rm]
    - [Rn,+/-Rm, shift_imm]
- **å‰åç§»ï¼ŒRnæ›´æ–°**
    - [Rn,#+/-offset_12]!
    - [Rn,+/-Rm]!
    - [Rn,+/-Rm, shift_imm]!
- **ååç§»ï¼ŒRnæ›´æ–°**
    - [Rn], # +/- offset_12
    - [Rn], +/-Rm
    - [Rn],+/-Rm, shift_imm

```nasm
ldr 	r0, [r1, #0x04]!
ldr 	r0, [r1, r2]! ;r1+r2->r0ï¼Œ æ›´æ–°r1
ldrh 	r2,[r1, -r0, LSR #0x04]! ;r1-r0 << 0x04 -> r2 æ›´æ–°r1
ldrb 	r0, [r1], #0x04 ; r1 -> r0 r1+4->r1
ldr 	r0,[r1],r2
rdr 	r0,[r1], -r0, LSL #0x04   
ldrsb r0, [r1, #0x04]
ldrh 	r0, [r1, r2]
ldr 	r2,[r1, -r0, LSR #0x04]
```

**â“ä¸‹åˆ—æŒ‡ä»¤çš„æ‰§è¡Œç»“æœ**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2027.png)

```nasm
LDR r0, [r1, #4]  ; r0 = 0x30303030, r1 = 0x104
LDR r0, [r1, #4]! ; r0 = 0x30303030, r1 = 0x108
LDR r0, [r1], #4  ; r0 = 0x80808080, r1 = 0x108
LDRB r0, [r1]     ; r0 = 0x80      , r1 = 0x104
LDRSB r0, [r1]    ; r0 = 0xffffff80, r1 = 0x104
```

**â“ä¸‹åˆ—æŒ‡ä»¤ï¼Œå“ªäº›æ˜¯æ­£ç¡®çš„**

```nasm
LDR r1, r2, r3 ;é”™
LDR r1, [r2, #0x111] ; å¯¹
LDR r1, [r2], +#0x11111 ; é”™
LDRSB r1, [r2], -#0x111 ; é”™
LDRH  [r1], r2  ; å¯¹
LDRSH r1, [r2, r3] ; å¯¹
LDRB r1, [r2,-r3] ; å¯¹

```

### å†™å†…å­˜æŒ‡ä»¤

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2028.png)

**åŒå­—è®¿é—®**

```nasm
    LDRD    r6,[r11]
    STRD    r4,[r9,#24]
    STRD    r0,abcd
    LDRD    r1,[r6]        ; Rd å¿…é¡»ä¸ºå¶æ•°
    STRD    r14,[r9,#36]   ; Rd ä¸èƒ½æ˜¯R14.
    STRD    r2,[r3],r6     ; Rn ä¸èƒ½æ˜¯ Rd æˆ– R(d+1).
```

**äº¤æ¢æ•°æ®**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2029.png)

â“åˆ†æä¸‹é¢æŒ‡ä»¤çš„æ‰§è¡Œç»“æœ

```nasm
mem32[0x8000]=0x12345678
R0=0x00000000
R1=0x22223333
R2=0x8000

SWP r0, r1, [r2]

mem32[0x8000]=0x22223333
R0=0x12345678
R1=0x22223333
R2=0x8000

```

### å¤šæ•°æ®è®¿é—®

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2030.png)

â—**å†…å­˜ä¸­çš„åœ°å€é¡ºåºä¸å¯„å­˜å™¨åºå·å¯¹åº”ï¼Œä¸åˆ—è¡¨ä¸­çš„æ¬¡åºæ— å…³ï¼** 
â“**åˆ†æä¸‹åˆ—æŒ‡ä»¤çš„ç»“æœ**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2031.png)

```nasm
LDMIA r0!,{r1-r3} ; r1 = 0x005, r2 = 0x006, r3 = 0x007, r0 = 0x8002c
LDMDA r0, {r3,r2}
LDMIB r0!,{r1-r3} ; r1 = 0x006, r2 = 0x007, r0 = 0x8002c
LDMDB r0, {r3,r2}
STMIA r0!,{r1-r3}
STMDA r0, {r3,r2}
STMIB r0!,{r1-r3}
STMDB r0, {r3,r2}
```

**æ ˆæ“ä½œ**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2032.png)

- å‘ä¸Šç”Ÿé•¿ï¼Œpopæ—¶åœ°å€åå‡ popï¼šLDMFA = LDMDAï¼Œpushï¼šSTMFA = STMIB
- å‘ä¸Šç”Ÿé•¿ï¼Œpopæ—¶åœ°å€å…ˆå‡ popï¼šLDMEA = LDMDBï¼Œpushï¼šSTMEA = STMIA
- å‘ä¸‹ç”Ÿé•¿ï¼Œpopæ—¶åœ°å€åå¢ popï¼šLDMFD = LDMIAï¼Œpushï¼šSTMED = STMDB
- å‘ä¸‹ç”Ÿé•¿ï¼Œpopæ—¶åœ°å€å…ˆå¢ popï¼šLDMED = LDMIBï¼Œ pushï¼šSTMED = STMDA

### **é¢„è®¡ç®—**

**â“â€œ subsÂ   r10, r10, #8*4â€ä¸­ï¼Œâ€œ 8*4â€** **åœ¨æŒ‡ä»¤æ‰§è¡Œæ—¶è®¡ç®—ï¼Ÿ**

ğŸ’¡åœ¨æ±‡ç¼–å™¨ä¸­è®¡ç®—ï¼Œè€Œéåœ¨å¤„ç†å™¨ä¸­è®¡ç®—

**ä¿ç•™å­—**

**r0-r15 and R0-R15ï¼Œa1-a4 (r0 to r3)ï¼Œv1-v8 (r4 to r11)ï¼Œsb and SB(r9)ï¼Œsl and SL (r10)ï¼Œfp and FP (r11)ï¼Œip and IP (r12)ï¼Œsp and SP (r13)ï¼Œlr and LR (r14)ï¼Œpc and PC (r15).**

**é¢„è®¡ç®—**

åŒç›®è®¡ç®—ã€å­—ç¬¦ä¸²ã€å•ç›®è®¡ç®—

```nasm
LDR r0, =? mydata ; 4*10
LDR r1, =? Mydata1 ; 1*4
				
mydata     DCD 1,2,3,4,5,6,7,8,9,0
Mydata1    DCB â€˜aâ€™, â€˜bâ€™, â€˜câ€™, â€˜dâ€™
```

```nasm
datastruc     	SPACE   280    
            	  MAP    	0,r8 ; 
consta          FIELD   4
constb         	FIELD   4
x               FIELD   8
y          		  FIELD   8
string          FIELD   256
           â€¦â€¦
LDR r3,=:BASE:y  ; è·å–åŸºåœ°å€
LDR r4,=:INDEX:y ; è·å–åç§»

```

### **å®å®šä¹‰**

```nasm
		MACRO                                  
$LOOP		MacSum $RD                             
		MOV v8, #0             
      
$LOOP.1 	ADD v8, $RD, v8
    SUBS $RD, $RD, #1
    BNE $LOOP.1
    MOV $RD, v8      
    MEND 
AREA mycode, CODE  
		ENTRY   
		CODE32                             
START   
     MOV R0, #100            
add100		MacSum R0                           
STOP
		b  STOP
    END

```

1. **$LOOP æ˜¯å‚æ•°å—ï¼Ÿ**

æ˜¯å®æ ‡ç­¾

1. **å¦‚æœå®å®šä¹‰ä¸­å»æ‰$LOOP, ç”¨ç¡®å®šlableâ€œloopâ€æ›¿ä»£â€œ$LOOP.1â€, ç¨‹åºè¿è¡Œçš„ç»“æœä¼šæœ‰å˜åŒ–å—ï¼Ÿ**

å¤šæ¬¡å¼•ç”¨ï¼Œæ ‡ç­¾é‡å¤

1. **$LOOP.1çš„ä½œç”¨ï¼Ÿ**

å±€éƒ¨æ ‡ç­¾ï¼Œå®å®šä¹‰ä½“å†…æœ‰æ•ˆ

### 64ä½è®¡ç®—

**64ä½æ•´æ•°åŠ å‡æ³•**

```nasm
LDR	R0, =0x00000022  ;åŠ è½½ç¬¬ä¸€ä¸ªæ•°çš„é«˜32ä½æ”¾åˆ°R0ä¸­
LDR	R1, =0x00330044   ;åŠ è½½ç¬¬ä¸€ä¸ªæ•°çš„ä½32ä½æ”¾åˆ°R1ä¸­
LDR	R2, =0x00000098			
LDR	R3, =0x76543210			
LDR	R6, =0x20000000   ;æŠŠå­˜å‚¨ç»“æœçš„å†…å­˜åœ°å€æ”¾åˆ°R6ä¸­
ADDS	R4, R1, R3ï¼ˆ SUBS  R4, R1, R3 ï¼‰	;ä½32ä½åŠ ï¼ˆå‡ï¼‰ï¼ŒR4å­˜å‚¨ä½32ä½
ADC	R5, R0, R2 ï¼ˆ SUBC  R5, R0, R2 ï¼‰ ;é«˜32ä½åŠ ï¼ˆå‡ï¼‰ï¼ŒR5å­˜å‚¨é«˜32ä½
STMIA	R6!,{R4,R5}   ;å°†R4ï¼ŒR5çš„æ•°æ®å­˜å‚¨åˆ°R6æŒ‡å‘çš„åœ°å€ä¸Šï¼ŒR6å€¼æ›´æ–°
```

**64ä½æ— ç¬¦å·æ•°ç›¸ä¹˜ï¼Œå¾—åˆ°64ä½æ— ç¬¦å·æ•°**

```nasm
Mul_64 to 64
stmfd	sp!, {r4,r5,lr}
umull	c_0,c_1, a_0, b_0 	;low *low 
mla	c_1, a_0,b_1,c_1	;low *high
mla 	c_1, a_1, b_0, c_1	;high* low
  
mov 	r0, c_0
mov	r1, c_1			;return

```

**64ä½æœ‰ç¬¦å·æ•°ç›¸ä¹˜ï¼Œå¾—åˆ°128ä½ç»“æœ**

## Debug

åœ¨Keilå·¥å…·é‡Œbuild info ï¼ˆæ ¹æ®ROï¼ŒRWï¼ŒRIè¯„ä¼°ç³»ç»Ÿç”¨çš„RAMå’ŒROMèµ„æºï¼‰ï¼Œå‡ºç°errorçš„æ—¶å€™åº”è¯¥æ€ä¹ˆè§£å†³ï¼ˆå¦‚link errorï¼Œæœªå®šä¹‰å˜é‡ï¼‰ï¼Œcæ˜¯ç¼–è¯‘é”™è¯¯ï¼ˆcä»£ç é”™è¯¯ï¼‰ï¼Œaæ˜¯æ±‡ç¼–é”™è¯¯ï¼ˆæ±‡ç¼–æ ¼å¼é”™è¯¯ï¼‰ï¼Œlé“¾æ¥é”™è¯¯ï¼ˆåº“ä¸å…¨ï¼Œåœ°å€åˆ†é…èµ„æºä¸å¤Ÿï¼‰

**Total ROÂ  Size (Code + RO Data)**

**Total RWÂ  Size (RW Data + ZI Data)Â Â Â Â Â Â Â Â Â RW-dataä»£è¡¨å·²åˆå§‹åŒ–çš„æ•°æ®ï¼ŒZI-dataä»£è¡¨æœªåˆå§‹åŒ–çš„æ•°æ®**Â  

**Total ROM Size (Code + RO Data + RW Data)**

## ATCPS

ATCPSï¼Œå‚æ•°ä¼ é€’ï¼Œè°ƒç”¨è¿”å›ï¼Œä¸­æ–­

**å‚æ•°ä¼ é€’å’Œè°ƒç”¨è¿”å›**

```nasm
å¯„å­˜å™¨çº¦å®š
R0-r3 (a1-a4) ä¼ é€’å‚æ•°
R4-r11 (v1-v8)ä¿å­˜å±€éƒ¨å˜é‡ ï¼ˆr4-r7 for Thumb)
R12 (ip) è¿‡ç¨‹é—´è‡ªå®šä¹‰æ•°æ®äº¤æ¢
R13 (sp) æ•°æ®å †æ ˆæŒ‡é’ˆ
R14 (lr) ä¿å­˜å­ç¨‹åºçš„è¿”å›åœ°å€
R15ï¼ˆpcï¼‰

å‚æ•°ä¼ è¾“è§„åˆ™
ã€ˆ =4ï¼Œ r0-r3,ä¾æ¬¡
å¤§äº4ï¼Œå­˜å…¥æ•°æ®æ ˆï¼Œæœ€åä¸€ä¸ªæ•°æ®å…ˆå…¥æ ˆ

æµ®ç‚¹å‚æ•°ä¼ é€’(é¡ºåºä¼ é€’)
FPA (Floating Point Arithmetic)
     f0-f7 (s0-s7, d0-d7,e0-e7)
VFP (d0-d15, s0-s31)

å‚æ•°è¿”å›è§„åˆ™ï¼ˆç»­ï¼‰
ç»“æœä¸º32bitæ•´æ•°æ—¶ï¼Œé€šè¿‡r0ä¼ é€’
ç»“æœä¸º64bitæ•´æ•°æ—¶ï¼Œé€šè¿‡r0å’ŒR1ä¼ é€’
ç»“æœä¸ºæµ®ç‚¹æ•°æ—¶ï¼Œé€šè¿‡æµ®ç‚¹å¯„å­˜å™¨è¿”å›(f0,d0)
æ›´å¤šçš„æ•°æ®é€šè¿‡å†…å­˜è¿”å›

```

**åµŒå…¥å¼æ±‡ç¼–**

- **ä¸æ”¯æŒ LDR Rn,= XXX å’Œ ADR, ADRL ä¼ªæŒ‡ä»¤**
- **ä¸æ”¯æŒ BX**
- **ç”¨â€&â€æ›¿ä»£ â€œ0xâ€** **è¡¨ç¤º16ä½æ•°æ®**

### å¼‚å¸¸å¤„ç†

**å‘é‡è¡¨**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2033.png)

**ç›´æ¥èµ‹å€¼å®ç°**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2034.png)

**è·³è½¬å®ç°**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2035.png)

**æ³¨å†Œå¼‚å¸¸å¤„ç†ç¨‹åº**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2036.png)

**ä¸­æ–­å‘é‡æ‰©å±•**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2037.png)

**ä¸­æ–­åµŒå¥—**

éåµŒå¥—ï¼šç¦æ­¢ä¸­æ–­â†’ä¿å­˜ä¸Šä¸‹æ–‡â†’ä¸­æ–­å¤„ç†â†’ä¸­æ–­æœåŠ¡â†’æ¢å¤ä¸Šä¸‹æ–‡â†’å…è®¸ä¸­æ–­â†’è¿”å›

åµŒå¥—    ï¼šç¦æ­¢ä¸­æ–­â†’ä¿å­˜ä¸Šä¸‹æ–‡â†’åˆ‡æ¢åˆ°SVCæ¨¡å¼â†’ä¿å­˜åˆ°SVCå †æ ˆâ†’å…è®¸ä¸­æ–­â†’ä¸­æ–­æœåŠ¡â†’æ¢å¤ä¸Šä¸‹æ–‡â†’è¿”å›

ldmfdÂ  sp!, {r0-r3, r12, r14}^ä¸­^çš„æ„ä¹‰æ˜¯åœ¨ç³»ç»Ÿæ¨¡å¼ä¸‹,åŒæ—¶åŠ è½½ç”¨æˆ·æ¨¡å¼ä¸‹çš„å¯„å­˜å™¨å€¼ã€‚

**SWI**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2038.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2039.png)

swiçš„å£°æ˜ï¼š __swi(0) int add_four(int, int, int, int);Â Â     

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2040.png)

è¿‡ç¨‹ï¼šå£°æ˜ä¸€ä¸ªswiå‡½æ•°ï¼ŒæŒ‡å®šè½¯ä¸­æ–­å·ï¼Œç„¶åæ³¨å†Œå¼‚å¸¸å¤„ç†ç¨‹åºï¼Œæ¥ç€è·³è½¬åˆ°SWI_Handlerè·å–ä¸­æ–­å·å‚æ•°å’Œå…¶ä»–è¿ç®—å‚æ•°ï¼Œè¿›å…¥C_SWI_Handlerã€‚å…·ä½“è·³è½¬è¿‡ç¨‹å‚è€ƒæˆ‘çš„ä½œä¸šã€‚

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2041.png)

ä¿å­˜ç°åœºå’Œpushæ ˆå¸§çš„åŒºåˆ«ï¼šä¿å­˜ç°åœºæ˜¯ä¿å­˜R0-R12, R14; pushæ ˆå¸§æ˜¯ä¿å­˜R4-R8, R14

**Scatter Scriptsï¼ˆæ²¡è¯´è¦è€ƒï¼Œæ„Ÿå…´è¶£ï¼‰**

- æ–‡æœ¬æ–‡ä»¶ .sct
- Linker è„šæœ¬æ–‡ä»¶ï¼›
- æ§åˆ¶äºŒè¿›åˆ¶ç¨‹åºå’Œæ•°æ®ç»„ä»¶çš„åˆ†ç»„å’Œåœ°å€åˆ†é…ï¼›
- æ˜ å°„ä¸­çš„æ¯ä¸ªåŒºåŸŸéƒ½å¯ä»¥å…·æœ‰ä¸åŒçš„åŠ è½½å’Œæ‰§è¡Œåœ°å€ï¼›

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2042.png)

> .icfæ–‡ä»¶
> 

ä¸ºé“¾æ¥å™¨æä¾›æœ‰å…³å¯èƒ½åœ°å€çš„æœ€å¤§å¤§å°çš„ä¿¡æ¯ï¼Œå¹¶å®šä¹‰å¯ç”¨çš„ç‰©ç†å†…å­˜ï¼Œä»¥åŠå¤„ç†å¯ä»¥ä»¥ä¸åŒæ–¹å¼å¯»å€çš„å†…å­˜ã€‚Â ä¾‹å¦‚å®šä¹‰å†…å­˜ä½ç½®ã€å†…å­˜å¤§å°å’Œå †æ ˆå¤§å°

**å¯åŠ¨ç¨‹åºåˆ†æ (S3C2410A)**

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2043.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2044.png)

> Reset
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2045.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2046.png)

é€šè¿‡IRQ_Entryä¸­çš„ä¸­æ–­æ‰©å±•å‘é‡è·³è½¬è¿›å…¥Reset_Handler

> Reset_Handler
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2047.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2048.png)

# ç¨‹åºä¼˜åŒ–ï¼ˆâ‰¤5%ï¼‰

---

### Overview

**ç›®æ ‡**

> **ç¨‹åºä¼˜åŒ–** åœ¨ä¸æ”¹å˜ç¨‹åºåŠŸèƒ½çš„æƒ…å†µä¸‹ï¼Œä½¿ç¨‹åºè¿è¡Œé€Ÿåº¦æ›´å¿«ï¼Œå ç”¨ç©ºé—´æ›´å°ï¼Œèƒ½è€—æ›´ä½
> 

> **ä¼˜åŒ–åŸåˆ™**
> 
- ç­‰æ•ˆåŸåˆ™ï¼ŒåŠŸèƒ½ä¸€è‡´
- æœ‰æ•ˆåŸåˆ™ï¼Œè¿è¡Œé€Ÿåº¦ã€å ç”¨ç©ºé—´ã€èƒ½è€—ä½ï¼Œæˆ–ä¸‰è€…å…¼æœ‰
- ç»æµåŸåˆ™ï¼Œè¾ƒå°ä»£ä»·

**æ‰‹æ®µ**

- ç®—æ³•ä¼˜åŒ–ï¼Œé€‰æ‹©ä¸€ç§é«˜æ•ˆçš„ç®—æ³•
- æ•°æ®ç»“æ„ä¼˜åŒ–ï¼Œé‡‡ç”¨è®¿é—®é€Ÿåº¦æ›´å¿«çš„æ•°æ®ç»“æ„
- ç¼–è¯‘ä¼˜åŒ–ï¼Œé…ç½®åˆé€‚çš„ç¼–è¯‘é€‰é¡¹
- ä»£ç ä¼˜åŒ–ï¼Œç”¨æ±‡ç¼–è¯­è¨€æˆ–ç²¾ç®€çš„ç¨‹åºä»£ç ä»£æ›¿åŸæœ‰çš„ä»£ç 

### é€Ÿåº¦ä¼˜åŒ–

**ç›®æ ‡**

- å‡å°‘æŒ‡ä»¤æ•°
- å‡å°‘è¿è¡Œæ—¶é—´ï¼š1ã€å‘¨æœŸï¼› 2ã€æ•°æ®è®¿é—®

**æ‰‹æ®µ**

- **è®¿å­˜å¯¹é½ï¼š**å¦‚æœæŸç±»å‹æ•°çš„å­˜è®¿åœ°å€æ˜¯è‡ªç„¶è¾¹ç•Œçš„æ•´æ•°å€ï¼ˆå¯¹é½ï¼‰ï¼Œåˆ™è®¿é—®æ•ˆç‡æœ€é«˜   ****
- **æ•°æ®ç±»å‹ï¼š**å°‘ç”¨charï¼Œå°‘ç”¨shortï¼Œå¤šç”¨intï¼Œéè´Ÿæ•°ç”¨æ— ç¬¦å·æ•´æ•°ï¼Œæµ®ç‚¹è½¬å®šç‚¹
- **å¾ªç¯ä½“ï¼š**
    - å¾ªç¯å±•å¼€ï¼šå‡å°‘å¾ªç¯è¿­ä»£æ¬¡æ•°ï¼Œå‡å°‘è·³è½¬æŒ‡ä»¤
    - å›ºå®šæ¬¡æ•°å¾ªç¯ï¼šforå¾ªç¯ç”¨é€’å‡è¾ƒä¼˜ï¼Œä¸å®šæ¬¡æ•°å¾ªç¯ï¼Œdo whileä¼˜äºforå¾ªç¯
- **è®¡ç®—æ›¿æ¢ï¼š**
    - å‡å°‘é‡å¤è¿ç®—
    - åˆ©ç”¨åŠ æ³•æ›¿æ¢ä¹˜æ³•å’Œç´¢å¼•
    - æ”¹å˜æŒ‡ä»¤é¡ºåºï¼Œå‡å°‘æŒ‡ä»¤é—´çš„ä¾èµ–
    - æŸ¥æ‰¾è¡¨
- **è®¿å­˜ç®¡ç†ï¼š**
    - è®¿é—®è¿ç»­çš„æ•°æ®åŒºï¼Œå……åˆ†åˆ©ç”¨cache
    - ä½¿ç”¨TCMï¼Œå°†è®¡ç®—é‡è¾ƒå¤§çš„ä»£ç å’Œå¸¸ç”¨æ•°æ®æ”¾åˆ°ç‰‡å†…RAMä¸­
    - å‡å°‘è®¿å­˜æ¬¡æ•°
- **åˆ†æ”¯è·³è½¬ï¼š**
    - å¯¹äºcaseè¯­å¥ï¼ŒæŠŠå¯èƒ½å‘ç”Ÿçš„caseæ”¾åœ¨å‰é¢

### èµ„æºä¼˜åŒ–

**æ‰‹æ®µ**

- **å‡å°ç¨‹åºç©ºé—´**
    - é€‰æ‹©çŸ­é•¿åº¦æŒ‡ä»¤é›†
    - è®¡ç®—æ›¿æ¢
    - å¾ªç¯æ›¿æ¢  (do while ç”±äº for )
    - æ•°æ®ç±»å‹ï¼ˆunsigned int ä¼˜äº int)
    - å–æ¶ˆå†…è”å‡½æ•°
- **ç»“æ„ä½“ã€ç©ºé—´å¤ç”¨**

### åŠŸè€—ä¼˜åŒ–

**æ‰‹æ®µ**

- ç¨‹åºæ‰§è¡ŒåŠŸè€—
    - å‡å°‘æŒ‡ä»¤æ•°
    - é€‰ç”¨åŠŸè€—ä½çš„æŒ‡ä»¤
- ç³»ç»Ÿç®¡ç†
    - é™ä½ä¸»é¢‘
    - çŠ¶æ€ç®¡ç†
    - æ¨¡å¼ç®¡ç†
- æ§åˆ¶ç³»ç»Ÿ
    - å‡å°‘è®¿å­˜æ¬¡æ•°
    - å…³æ–­ç©ºé—²å¤–è®¾

# RISC-Vï¼ˆ5%-10%ï¼‰

---

## RISC-Vçš„ç»“æ„ç‰¹ç‚¹ï¼Œé‡ç‚¹æ¯”è¾ƒRISC-Vå’ŒARMçš„åŒºåˆ«ï¼Œå¼€æºå¤„ç†å™¨çš„å¼€æºå†…å®¹æ˜¯ä»€ä¹ˆ

### ç‰¹ç‚¹

ç®€æ´æ€§ã€æ¶æ„å’Œå®ç°çš„åˆ†ç¦»ã€æ˜“äºç¼–ç¨‹ã€ç¼–è¯‘ã€é“¾æ¥ã€ç¨‹åºå¤§å°é™ä½

- **æ¨¡å—åŒ–**
    - æ”¯æŒæ¨¡å—åŒ–å¯é…ç½®çš„æŒ‡ä»¤å­é›†
- **å¯æ‰©å±•æ€§**
    - æ”¯æŒå¯æ‰©å±•å®šåˆ¶æŒ‡ä»¤
- **æ˜“å®ç°æ€§**
    - ç¡¬ä»¶è®¾è®¡ä¸ç¼–è¯‘å™¨å®ç°éå¸¸ç®€å•
        - ä»…æ”¯æŒå°ç«¯æ¨¡å¼
        - è§„æ•´çš„æŒ‡ä»¤ç¼–ç æ ¼å¼
        - ä¸ä½¿ç”¨æŒ‡ä»¤æ¡ä»¶ç¼–ç 
        - å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤ä¸€æ¬¡åªè®¿é—®ä¸€ä¸ªå…ƒç´ 
        - å»é™¤å­˜å‚¨å™¨è®¿é—®æŒ‡ä»¤çš„åœ°å€è‡ªå¢å’Œè‡ªå‡æ¨¡å¼

### ä¸ARMçš„åŒºåˆ«

æŒ‡ä»¤ç¼–ç æ›´è§„æ•´

æ²¡æœ‰åœ°å€è‡ªå¢/è‡ªå‡çš„è®¿å­˜æŒ‡ä»¤

æ²¡æœ‰æ¡ä»¶æ‰§è¡Œ

æ²¡æœ‰æ”¹å˜æ ‡å¿—ä½

â€¦

**å¼€æºå¤„ç†å™¨çš„å¼€æºå†…å®¹**

1. å¤„ç†å™¨æ¶æ„çš„è§„èŒƒå’Œè®¾è®¡æ–‡æ¡£: è¿™åŒ…æ‹¬æŒ‡ä»¤é›†æ¶æ„ã€å¯„å­˜å™¨å®šä¹‰ã€å†…å­˜ç®¡ç†ç­‰åŸºæœ¬ç»“æ„çš„è¯¦ç»†è¯´æ˜ã€‚
2. å¤„ç†å™¨ RTL ï¼ˆå¯„å­˜å™¨ä¼ è¾“çº§ï¼‰æºä»£ç : è¿™æ˜¯ç”¨ç¡¬ä»¶æè¿°è¯­è¨€ï¼ˆå¦‚ Verilog æˆ– VHDLï¼‰ç¼–å†™çš„å¤„ç†å™¨æ ¸å¿ƒå®ç°ä»£ç ã€‚
3. æ¨¡æ‹Ÿå’ŒéªŒè¯æµ‹è¯•ç”¨ä¾‹: ç”¨äºéªŒè¯å¤„ç†å™¨è¡Œä¸ºæ­£ç¡®æ€§çš„å„ç§æµ‹è¯•ç¨‹åºå’Œè¾“å…¥æ•°æ®é›†ã€‚
4. ç¼–è¯‘å™¨å’Œå·¥å…·é“¾: é€šå¸¸ä¼šæä¾›å¤„ç†å™¨çš„ç¼–è¯‘å™¨å‰ç«¯ã€æ±‡ç¼–å™¨ã€é“¾æ¥å™¨ç­‰æ”¯æŒå·¥å…·ã€‚
5. å‚è€ƒæ“ä½œç³»ç»Ÿå’Œåº”ç”¨ç¨‹åº: ä¸€äº›å¼€æºå¤„ç†å™¨ä¼šæä¾›å‚è€ƒè®¾è®¡çš„æ“ä½œç³»ç»Ÿä»¥åŠåŸºç¡€åº”ç”¨ç¨‹åºã€‚
6. æ–‡æ¡£å’Œæ•™ç¨‹: æ¶µç›–å¤„ç†å™¨ä½¿ç”¨ã€ç¼–ç¨‹ã€æ€§èƒ½ä¼˜åŒ–ç­‰æ–¹æ–¹é¢é¢çš„æŒ‡å—å’Œè¯´æ˜ã€‚

# å¤šæ ¸å¤„ç†å™¨ï¼ˆâ‰¥20%ï¼‰

---

## OpenMP

```c
#include "stdafx.h"
#include "omp.h"
int _tmain(int argc, _TCHAR* argv[]){     
     printf("Hello from serial.\n");
     printf("Thread number = %d\n",
     omp_get_thread_num());  //serial
    #pragma omp parallel {       //parallel
     printf("Hello from parallel.Thread number 
          = %d\n",omp_get_thread_num());
     }
     printf("Hello from serial again.\n");
     return;
}

```

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2049.png)

### å¾ªç¯å¹¶è¡ŒåŒ–ï¼Œå¦‚æœæœ‰å¤šå±‚å¾ªç¯åœ¨å“ªä¸€å±‚å¹¶è¡Œæ•ˆæœè¾ƒå¥½

å¾ªç¯å¹¶è¡Œæ¦‚å¿µï¼š

**#pragma omp parallel for [clause[clauseâ€¦]]**

```c
int step = 20;
int _tmain(int argc, _TCHAR* argv[]){
    int i;
   #pragma omp parallel for
   for (i = 0; i< step; i++){
       printf("i = %d\n", i);}
   return 0;
}

```

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2050.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2051.png)

ä»¥ä¸‹ä¸¤æ®µç¨‹åºæ˜¯ç­‰æ•ˆçš„

```c
#pragma omp parallel {	
    #pragma omp for
    for (i=0;i< MAX; i++){
    res[i] = huge();
    } 
}	

```

```c
#pragma omp parallel for
for (i=0;i< MAX; i++){    
  res[i] = huge();
} 
```

å³è¾¹å½¢å¼ä½œç”¨åŸŸåªæ˜¯ç´§è·Ÿç€çš„é‚£ä¸ªforå¾ªç¯ï¼Œè€Œå·¦è¾¹å½¢å¼åœ¨æ•´ä¸ªå¹¶è¡Œå—ä¸­å¯ä»¥å‡ºç°å¤šä¸ªforåˆ¶å¯¼æŒ‡ä»¤ã€‚

è¿™ä¹Ÿå°±æ„å‘³ç€ï¼Œå‡å¦‚æƒ³åœ¨ä¸¤ä¸ªåšäº†å¾ªç¯å¹¶è¡Œçš„forå¾ªç¯ä¸­é—´æ’å…¥ä¸€æ¡å•çº¿ç¨‹è¯­å¥ï¼Œå³è¾¹å°±ä¸ç”¨ç®¡ï¼Œå·¦è¾¹åˆ™éœ€è¦åŠ ä¸Š#pragma omp master æˆ– #pragma omp singleï¼Œå¦‚ä¸‹æ‰€ç¤º

```c
#pragma omp parallel
	{
#pragma omp for
		for (int i = 0; i < 6; i++)
			printf("i = %d, I am Thread %d\n", i, omp_get_thread_num());
#pragma omp master
		{
			//è¿™é‡Œçš„ä»£ç ç”±ä¸»çº¿ç¨‹æ‰§è¡Œ
			printf("I am Thread %d\n", omp_get_thread_num());
		}
#pragma omp for
		for (int i = 0; i < 6; i++)
			printf("i = %d, I am Thread %d\n", i, omp_get_thread_num());
	}

```

```c
#pragma omp parallel for
	for (int i = 0; i < 6; i++)
		printf("i = %d, I am Thread %d\n", i, omp_get_thread_num());
	//è¿™é‡Œæ˜¯ä¸¤ä¸ªforå¾ªç¯ä¹‹é—´çš„ä»£ç ï¼Œå°†ä¼šç”±çº¿ç¨‹0å³ä¸»çº¿ç¨‹æ‰§è¡Œ
	printf("I am Thread %d\n", omp_get_thread_num());
#pragma omp parallel for
	for (int i = 0; i < 6; i++)
		printf("i = %d, I am Thread %d\n", i, omp_get_thread_num());
```

### å˜é‡ç§åŒ–

```c
ifirst = 10;
int k[600];
int i, j,i2;
for(j = 0; j <= 60; j++){
	for(i=0;i<6000000;i++){ 
     i2 = i-(i/600)*600;
     k[i2] = ifirst + i;}
}
// time = 1505

ifirst = 10;
int k[600];
int i,j,i2;
for(j = 0; j <= 60; j++){
#pragma omp parallel for
	for(i=0;i<6000000;i++){ 
     i2 = i-(i/600)*600;
     k[i2] = ifirst + i;}
}

// time = 2140
```

åŠ äº†pragma parrelle foråè€Œå˜æ…¢çš„åŸå› æ˜¯ï¼šæ‰€æœ‰çº¿ç¨‹ä¼šè®¿é—®åŒä¸€ä¸ªå…±äº«å˜é‡ï¼Œéœ€è¦å°†è¿™ä¸ªå˜é‡ç§æœ‰åŒ–ï¼Œå¾ªç¯çš„ç´¢å¼•æœ¬èº«å°±æ˜¯çº¿ç¨‹ç§æœ‰çš„

```c
ifirst = 10;
int k[600];
int i,j,i2;
for(j = 0; j <= 60; j++){
#pragma omp parallel for private(i2)
	for(i=0;i<6000000;i++){ 
     i2 = i-(i/600)*600;
     k[i2] = ifirst + i;}
}
// time = 910
```

æ³¨æ„ï¼Œå®ƒæ˜¯åœ¨forå¾ªç¯å‰é¢

### å˜é‡ä¿æŠ¤

```c
float RES;
float B; 
#pragma omp parallel forfor(int i=0; i<niters; i++){
  B = big_job(i);
#pragma omp critical (RES_lock)  consum (B, RES);}}
```

```c
unsigend sum = 0.0;
float a[LP_N],b[LP_N];
sum=0.0;
#pragma omp parallel for
for(int i=0; i<LP_N; i++) {
  #pragma omp critical (sum_lock)	
   sum += abs(10*sin(double(a[i] *    
     (b[i]+1)/ (b[i] + a[i] + 1))));}
printf("sum=%d\n", sum);  
```

è¿™æ ·èƒ½ä¿è¯æ­£ç¡®çš„ç»“æœï¼Œä½†æ—¶é—´è¾ƒé•¿ï¼Œå› ä¸ºä¸´ç•ŒåŒºæ˜¯è¿™æ ·çš„ï¼Œæ³¨æ„è¿™é‡Œpragma omp criticalåœ¨å¾ªç¯å†…

```c
unsigend sum = 0.0;
float a[LP_N],b[LP_N]; 
sum=0.0;
#pragma omp parallel for reduction(+:sum)
for(int i=0; i<LP_N; i++) {
	 sum += abs(10*sin(double(a[i] * (b[i]+1)/ (b[i] + a[i] + 1))));
}	
printf("sum=%d\n", sum);  

```

æ¯ä¸ªçº¿ç¨‹æ‹·è´ä¸€ä»½sumå˜é‡ï¼Œé€€å‡ºå¾ªç¯åå†æŠŠå„ä¸ªçº¿ç¨‹çš„sumç›¸åŠ ï¼Œè¿™æ ·å°±æ›´å¿«äº†

### **çº¿ç¨‹è°ƒåº¦**

æ ¼å¼ï¼š#pragma omp parallel for schedule(static, size)

- **é™æ€è°ƒåº¦static**

ç¼–è¯‘å™¨åœ¨æ‰§è¡Œæ²¡æœ‰ä½¿ç”¨scheduleçš„å¹¶è¡ŒæŒ‡ä»¤æ—¶ï¼Œé»˜è®¤æ˜¯staticå­å¥ã€‚staticåœ¨ç¼–è¯‘çš„è¿‡ç¨‹ä¸­ï¼Œå°±å·²ç»ç¡®å®šäº†çº¿ç¨‹çš„åˆ†é…æ–¹æ¡ˆã€‚å¦‚æœä¸ä½¿ç”¨sizeåˆ¶å®šï¼Œé»˜è®¤æ¯ä¸€ä¸ªçº¿ç¨‹ä¼šåˆ†é…N/num_threadsä¸ªè¿­ä»£ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå…ˆç»™ç¬¬ä¸€ä¸ªçº¿ç¨‹ç›´æ¥åˆ†é…N/num_threadsä¸ªï¼Œä¾æ¬¡éå†æ¯ä¸€ä¸ªçº¿ç¨‹ã€‚ä½†æ˜¯å¦‚æœè®¾ç½®äº†sizeï¼Œé¦–å…ˆç»™ç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ†é…sizeä¸ªè¿­ä»£ï¼Œç„¶ååˆ†é…åˆ°æœ€åä¸€ä¸ªçº¿ç¨‹ï¼Œå†ç»™ç¬¬ä¸€ä¸ªçº¿ç¨‹åˆ†é…ã€‚

- **åŠ¨æ€è°ƒåº¦dynamic**

å¯¹äºåœ¨å®é™…è¿è¡Œçš„è¿‡ç¨‹ï¼Œæœ‰çš„çº¿ç¨‹æ‰§è¡Œé€Ÿåº¦è¾ƒå¿«ï¼Œå› æ­¤åœ¨æ‰§è¡Œå®Œä¹‹åä¼šå»é¢†å–æ–°çš„ä»»åŠ¡ã€‚å¦‚æœä¸è®¾ç½®`size`ï¼Œæ˜¯ä¼šè¿­ä»£æ¯ä¸€ä¸ªå¾ªç¯åˆ†é…ç»™å„ä¸ªçº¿ç¨‹ï¼Œå¦‚æœä½¿ç”¨`size`ï¼Œä¼šæ¯æ¬¡åˆ†é…`size`ä¸ªç»™ä¸€ä¸ªçº¿ç¨‹ã€‚

- **å¯å‘å¼è°ƒåº¦guided**

é‡‡ç”¨å¯å‘å¼è°ƒåº¦æ–¹æ³•è¿›è¡Œè°ƒåº¦ï¼Œæ¯æ¬¡åˆ†é…ç»™çº¿ç¨‹è¿­ä»£æ¬¡æ•°ä¸åŒï¼Œå¼€å§‹æ¯”è¾ƒå¤§ï¼Œä»¥åé€æ¸å‡å°ã€‚sizeè¡¨ç¤ºæ¯æ¬¡åˆ†é…çš„è¿­ä»£æ¬¡æ•°çš„æœ€å°å€¼ï¼Œç”±äºæ¯æ¬¡åˆ†é…çš„è¿­ä»£æ¬¡æ•°ä¼šé€æ¸å‡å°‘ï¼Œå°‘åˆ°sizeæ—¶ï¼Œå°†ä¸å†å‡å°‘ã€‚å¦‚æœä¸çŸ¥é“sizeçš„å¤§å°ï¼Œé‚£ä¹ˆé»˜è®¤sizeä¸º1ï¼Œå³ä¸€ç›´å‡å°‘åˆ°1ã€‚
æ¯ä¸ªä»»åŠ¡åˆ†é…çš„ä»»åŠ¡æ˜¯å…ˆå¤§åå°ï¼ŒæŒ‡æ•°ä¸‹é™ã€‚å½“æœ‰å¤§é‡ä»»åŠ¡éœ€è¦å¾ªç¯æ—¶ï¼Œåˆšå¼€å§‹ä¸ºçº¿ç¨‹åˆ†é…å¤§é‡ä»»åŠ¡ï¼Œæœ€åä»»åŠ¡ä¸å¤šæ—¶ï¼Œç»™æ¯ä¸ªçº¿ç¨‹å°‘é‡ä»»åŠ¡ï¼Œå¯ä»¥è¾¾åˆ°çº¿ç¨‹ä»»åŠ¡å‡è¡¡ã€‚

### çº¿ç¨‹æ§åˆ¶

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2052.png)

åˆ¶å¯¼è¯­å¥barrierï¼Œç”¨å®ƒå¯ä»¥åœ¨å¹¶è¡Œå—ä¸­è®¾ç½®ä¸€ä¸ªè·¯éšœï¼Œå¿…é¡»ç­‰å¾…æ‰€æœ‰çº¿ç¨‹åˆ°è¾¾æ—¶æ‰èƒ½é€šè¿‡ï¼Œè¿™ä¸ªä¸€èˆ¬åœ¨å¹¶è¡Œå¤„ç†å¾ªç¯å‰åå­˜åœ¨ä¾èµ–çš„ä»»åŠ¡æ—¶ä½¿ç”¨åˆ°ã€‚

### å…¶ä»–

è´Ÿè½½å‡è¡¡ï¼šå‰äº”åæ¬¡å¾ªç¯ small work, åäº”åæ¬¡å¾ªç¯ big work

å¯å¹¶è¡Œæ€§ï¼šä¸€ä¸ªçº¿ç¨‹ä¸Šçš„dataä¾èµ–äºå¦ä¸€ä¸ªçº¿ç¨‹

**â“å¦‚æœæœ‰å¤šå±‚å¾ªç¯å¯¹å“ªä¸€å±‚å¾ªç¯å¹¶è¡Œæœ€å¥½ï¼Ÿ**

(1ï¼‰å¦‚æœå¤–å±‚å¾ªç¯æ¬¡æ•°è¿œè¿œå°äºå†…å±‚å¾ªç¯æ¬¡æ•°ï¼Œå†…å±‚å¾ªç¯è¾ƒå¤šæ—¶ï¼Œå°†parallel foråŠ åœ¨å†…å±‚å¾ªç¯ã€‚

(2) å¦åˆ™å°†parallel for åŠ åœ¨æœ€å¤–å±‚å¾ªç¯ï¼Œä¸€èˆ¬æƒ…å†µéƒ½æ˜¯è¿™æ ·ã€‚

## GPU

### CUDAï¼Œå¦‚ä½•æ„å»ºå¹¶è°ƒç”¨æ ¸å‡½æ•°ï¼Œå®šä¹‰çº¿ç¨‹çš„åŠŸèƒ½

### overview

__global__è¿”å›å€¼å¿…é¡»æ˜¯void

__global__ void hello_world_kernel () {};

hello_world_kernel <<<1, 1>>>();

### æ ¸å‡½æ•°å£°æ˜

__device__ float DeviceFunc() åœ¨deviceä¸Šæ‰§è¡Œï¼Œåœ¨deviceä¸Šè°ƒç”¨

__global__ void KernelFunc() åœ¨deviceä¸Šæ‰§è¡Œï¼Œåœ¨hostä¸Šè°ƒç”¨

æ ¸å‡½æ•°ä¼šåœ¨Nä¸ªä¸åŒçš„CUDAçº¿ç¨‹ä¸Šå¹¶è¡Œæ‰§è¡ŒNæ¬¡

ç”¨äºæ‰§è¡Œæ ¸å‡½æ•°çš„CUDAçº¿ç¨‹æ•°é‡åœ¨<<<>>>ä¸­æŒ‡å®š    **<<<nBlk, nTid>>>(â€¦)**   

æ¯ä¸€ä¸ªæ‰§è¡Œæ ¸å‡½æ•°çš„çº¿ç¨‹éƒ½è¢«æŒ‡å®šäº†ä¸€ä¸ªç‰¹æ®Šçš„çº¿ç¨‹ID

> ç¤ºä¾‹
> 

```c
__global__ void addKernel(int *c, const int *a, const int *b)
{
    int i = threadIdx.x;
    c[i] = a[i] + b[i];
}
//è°ƒç”¨
addKernel<<<1, size>>>(dev_c, dev_a, dev_b);
```

### **çº¿ç¨‹å—**

- åŒ…å«äº†ä¸€ç»„çº¿ç¨‹
- æ‰€æœ‰çš„çº¿ç¨‹éƒ½æ‰§è¡ŒåŒä¸€æ®µä»£ç 
- æ¯ä¸€ä¸ªçº¿ç¨‹éƒ½æœ‰å¯¹åº”çš„ç¼–å·ä¾¿äºè¿›è¡Œå­˜å‚¨åœ°å€è®¡ç®—æˆ–è€…è¿›è¡Œæ§åˆ¶å†³ç­–
- çº¿ç¨‹ä¹‹é—´é€šè¿‡å…±äº«æ•°æ®ä»¥åŠåŒæ­¥æ‰§è¡Œæ¥åä½œ
- æ¥è‡ªä¸åŒçº¿ç¨‹å—çš„çº¿ç¨‹æ²¡åŠæ³•åä½œ
- æ¯ä¸€ä¸ªçº¿ç¨‹å—ä¸­çš„çº¿ç¨‹æ•°é‡æœ‰é™åˆ¶

### çº¿ç¨‹ç»„ç»‡ç»“æ„ä¸çº¿ç¨‹æ¨¡å‹

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2053.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2054.png)

kernelå°±æ˜¯è¿è¡Œåœ¨deviceä¸Šçš„å‡½æ•°

### çº¿ç¨‹å—è°ƒåº¦

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2055.png)

æ¯ä¸€ä¸ªBlockå¯ä»¥ä»¥ä»»æ„çš„é¡ºåºæ¥æ‰§è¡Œï¼ˆç›¸å¯¹äºå…¶ä»–block)

### Built-in variables

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2056.png)

> example
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2057.png)

### çº¿ç¨‹å—ä¾‹ç¨‹

```c
// 1-D block for vector add
__global__ void VecAdd(float* A, float* B, float* C){// Kernel definition
   int i = threadIdx.x;
    C[i] = A[i] + B[i];
}
int main(){
    ...
    VecAdd<<<1, N>>>(A, B, C); // Kernel invocation with N threads
    ...}

// 2-D block for matrix add
__global__ void MatAdd(float A[N][N], float B[N][N], float C[N][N]){
    int i = threadIdx.x;
    int j = threadIdx.y;
    C[i][j] = A[i][j] + B[i][j];
}
int main(){
    ...
    int numBlocks = 1; // Kernel invocation with one block of N * N * 1 threads
    dim3 threadsPerBlock(N, N);
    MatAdd<<<numBlocks, threadsPerBlock>>>(A, B, C);
    ...
}

// 2-D block for matrix, add another example
__global__ void MatAdd(float A[N][N], float B[N][N], float C[N][N])
{
    int i = blockIdx.x * blockDim.x + threadIdx.x;
    int j = blockIdx.y * blockDim.y + threadIdx.y;
    if (i < N && j < N)
        C[i][j] = A[i][j] + B[i][j];
}

int main()
{
    ...
    // Kernel invocation
    dim3 threadsPerBlock(16, 16);
    dim3 numBlocks(N / threadsPerBlock.x, N / threadsPerBlock.y);
    MatAdd<<<numBlocks, threadsPerBlock>>>(A, B, C);
    ...
}
```

### GPUå­˜å‚¨

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2058.png)

### å­˜å‚¨ç®¡ç†

> **Global memory**
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2059.png)

> **shared memory**
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2060.png)

> **local memory**
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2061.png)

> **Memcpy**
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2062.png)

### Host call device

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2063.png)

### Example

> Array Plus
> 

```c
#include "cuda_runtime.h"
#include <stdio.h>
cudaError_t addWithCuda(int *c, const int *a, const int *b, unsigned int size);
__global__ void addKernel(int *c, const int *a, const int *b){
    int i = threadIdx.x;
    c[i] = a[i] + b[i];
}

cudaError_t addWithCuda(int *c, const int *a, const int *b,  unsigned int size){
    int *dev_a = 0; int *dev_b = 0; int *dev_c = 0;
    cudaError_t cudaStatus;
    cudaStatus = cudaMalloc((void**)&dev_c, size * sizeof(int));
    if (cudaStatus != cudaSuccess) { goto Error;} 
    cudaStatus = cudaMalloc((void**)&dev_a, size * sizeof(int));
    if (cudaStatus != cudaSuccess) {goto Error;}
    cudaStatus = cudaMalloc((void**)&dev_b, size * sizeof(int));
    if (cudaStatus != cudaSuccess) {goto Error;}
    cudaStatus = cudaMemcpy(dev_a, a, size * sizeof(int),  cudaMemcpyHostToDevice); 
    if (cudaStatus != cudaSuccess) { goto Error;}
     cudaStatus = cudaMemcpy(dev_b, b, size * sizeof(int), cudaMemcpyHostToDevice);
    if (cudaStatus != cudaSuccess) {goto Error;}
    addKernel<<<1, size>>>(dev_c, dev_a, dev_b);
    cudaStatus = cudaGetLastError();
    if (cudaStatus != cudaSuccess) {goto Error;}
    cudaStatus = cudaDeviceSynchronize();
    if (cudaStatus != cudaSuccess) {goto Error;}
   cudaStatus = cudaMemcpy(c, dev_c, size * sizeof(int), cudaMemcpyDeviceToHost);
    if (cudaStatus != cudaSuccess) {goto Error;}
Error:
    cudaFree(dev_c); cudaFree(dev_a); cudaFree(dev_b);  
    return cudaStatus;}

int main(){
    const int arraySize = 5;
    const int a[arraySize] = { 1, 2, 3, 4, 5 };
    const int b[arraySize] = { 10, 20, 30, 40, 50 };
    int c[arraySize] = { 0 };
    cudaError_t cudaStatus = addWithCuda(c, a, b, arraySize); // Add vectors in parallel.
    if (cudaStatus != cudaSuccess) { return 1; }
    printf("{1,2,3,4,5} + {10,20,30,40,50} = {%d,%d,%d,%d,%d}\n", c[0], c[1], c[2], c[3], c[4]);
    cudaStatus = cudaDeviceReset();
    if (cudaStatus != cudaSuccess) {return 1; }
    return 0;
}

```

> **1D Low Pass Filter**
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2064.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2065.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2066.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2067.png)

> **Matrix Multiplication**
> 

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2068.png)

![Untitled](%E5%B5%8C%E5%85%A5%E5%BC%8F%E5%A4%8D%E4%B9%A0%E7%AC%94%E8%AE%B0%20725dae2d54374b9c8ef31fceb1f19daf/Untitled%2069.png)